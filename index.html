<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIOU Studio Ultimate</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #006064; --bg: #f5f7fa; --surface: #ffffff; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
        header { background: rgba(255,255,255,0.85); backdrop-filter: blur(8px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid rgba(0,0,0,0.05); }
        header h1 { margin: 0; font-size: 1.2rem; color: var(--primary); font-weight: 800; }
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .tab { display: none; }
        .tab.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .card { background: var(--surface); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid #fff; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #555; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; }
        .file-list .item { display: flex; align-items: center; padding: 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; justify-content: space-between; transition: 0.2s; }
        .file-list .item:hover { border-color: var(--primary); }
        textarea, input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-family:inherit; box-sizing: border-box;}
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; background: var(--primary); margin-top: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 20; }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #999; font-size: 0.7rem; font-weight: 600; gap: 4px; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 1.4rem; }
        .folder-icon { color: #fbc02d; margin-right: 10px; }
        .file-icon { color: #90a4ae; margin-right: 10px; }
        .action-icon { color: #f44336; margin-left:10px; padding:5px; cursor:pointer; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: opacity 0.3s; opacity: 0; }
        #toast.show { visibility: visible; opacity: 1; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(0,96,100,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <h1>AIOU Studio</h1>
        <div id="status" style="font-size: 12px; color: #666; font-weight:600;"><i class="fa-solid fa-circle-check" style="color:#4caf50"></i> Ready</div>
    </header>
    <main>
        <div id="tab-home" class="tab active">
            <div class="card">
                <input type="text" id="magicCode" placeholder="Magic Find (e.g. 1423 1424)">
                <button onclick="magicFind()" class="btn"><i class="fa-solid fa-magnifying-glass"></i> Find Assignments</button>
            </div>
            <div id="magicResults"></div>
            
            <div class="card" style="margin-top:20px;">
                <div class="card-head">
                    <span id="currentPathLabel" style="font-family:monospace; background:#eee; padding:2px 6px; border-radius:4px; font-size:11px;">/</span>
                    <div style="display:flex; gap:5px;">
                        <input type="file" id="fileImport" style="display:none" onchange="importFile(this)">
                        <button class="btn" style="width:auto; padding:8px 12px; background:#4caf50;" onclick="document.getElementById('fileImport').click()"><i class="fa-solid fa-upload"></i></button>
                        <button class="btn" style="width:auto; padding:8px 12px; background:#fbc02d; color:#333;" onclick="createFolder()"><i class="fa-solid fa-folder-plus"></i></button>
                        <button class="btn" style="width:auto; padding:8px 12px; background:#e91e63;" onclick="processCurrentFolder()"><i class="fa-solid fa-file-pdf"></i> Batch</button>
                    </div>
                </div>
                <div id="explorerList" class="file-list"></div>
            </div>
        </div>

        <div id="tab-editor" class="tab">
            <div class="card">
                <input type="text" id="fileName" placeholder="File Name (e.g. 1423_1.md)">
                <textarea id="editor" rows="18" style="font-family: monospace; font-size:13px;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveFile()" class="btn" style="flex:1"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                    <button onclick="generatePdf()" id="genPdfBtn" class="btn" style="background:#00897b; flex:1"><i class="fa-solid fa-print"></i> Generate PDF</button>
                </div>
            </div>
        </div>

        <div id="tab-themes" class="tab">
            <div class="card">
                <div class="card-head">Theme Manager</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="themeLang" onchange="renderThemeList()" style="width:50%"><option value="english">English</option><option value="urdu">Urdu</option></select>
                    <select id="themeName" onchange="loadThemeContent()" style="width:50%"></select>
                </div>
                <div style="margin-bottom:10px; font-size:12px; color:#666; background:#f5f5f5; padding:8px; border-radius:6px;">
                    <i class="fa-solid fa-check-circle" style="color:#4caf50"></i> Active Theme: <span id="activeThemeLabel" style="font-weight:bold; color:#333;"></span>
                </div>
                <textarea id="themeEditor" rows="12" style="font-family:monospace; font-size:12px; background:#fafafa;"></textarea>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button onclick="saveTheme()" class="btn" style="flex:1"><i class="fa-solid fa-save"></i> Update</button>
                    <button onclick="activateTheme()" class="btn" style="background:#4caf50; flex:1"><i class="fa-solid fa-bolt"></i> Set Active</button>
                </div>
                <button onclick="deleteTheme()" class="btn" style="background:#f44336; margin-top:10px;"><i class="fa-solid fa-trash"></i> Delete Theme</button>
            </div>
        </div>

        <div id="tab-settings" class="tab">
            <div class="card">
                <div class="card-head">Global Configuration</div>
                <div style="font-size:12px; color:#666; margin-bottom:10px;">English Details</div>
                <input type="text" id="cfgName" placeholder="Student Name">
                <input type="text" id="cfgRoll" placeholder="Registration Number">
                <input type="text" id="cfgSem" placeholder="Semester (e.g. Autumn 2024)">
                
                <div style="font-size:12px; color:#666; margin-top:20px; margin-bottom:10px; text-align:right;">اردو تفصیلات</div>
                <input type="text" id="cfgNameUr" placeholder="طالب علم کا نام" style="text-align:right; font-family:'JameelNoori', serif; font-size:16px;">
                <input type="text" id="cfgRollUr" placeholder="رجسٹریشن نمبر" style="text-align:right; font-family:'JameelNoori', serif; font-size:16px;">
                <input type="text" id="cfgSemUr" placeholder="سمسٹر" style="text-align:right; font-family:'JameelNoori', serif; font-size:16px;">
                
                <button onclick="saveConfig()" class="btn" style="margin-top:20px;"><i class="fa-solid fa-check"></i> Save Settings</button>
            </div>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" onclick="switchTab('home')"><i class="fa-solid fa-folder-open"></i><span>Files</span></button>
        <button class="nav-btn" onclick="switchTab('editor')"><i class="fa-solid fa-pen-to-square"></i><span>Editor</span></button>
        <button class="nav-btn" onclick="switchTab('themes')"><i class="fa-solid fa-palette"></i><span>Themes</span></button>
        <button class="nav-btn" onclick="switchTab('settings')"><i class="fa-solid fa-gear"></i><span>Settings</span></button>
    </nav>
    <div id="toast">Message</div>

    <script>
        let currentPath = ''; let themesData = {};
        function showToast(msg) { const t = document.getElementById("toast"); t.innerHTML = msg; t.className = "show"; setTimeout(() => t.className = t.className.replace("show", ""), 3000); }
        function setStatus(msg, isLoading = false) { document.getElementById('status').innerHTML = isLoading ? '<span class="spinner"></span> ' + msg : '<i class="fa-solid fa-circle-check" style="color:#4caf50"></i> ' + msg; }
        
        loadExplorer(''); loadThemes();
        const config = JSON.parse(localStorage.getItem('aiou_config') || '{}');
        ['cfgName','cfgRoll','cfgSem','cfgNameUr','cfgRollUr','cfgSemUr'].forEach(id => { if(config[id]) document.getElementById(id).value = config[id]; });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function loadThemes() { themesData = await (await fetch('/api/themes')).json(); renderThemeList(); }
        function renderThemeList() {
            const lang = document.getElementById('themeLang').value;
            const list = document.getElementById('themeName');
            const data = lang === 'english' ? themesData.english : themesData.urdu;
            const active = lang === 'english' ? themesData.activeEnglish : themesData.activeUrdu;
            document.getElementById('activeThemeLabel').innerText = active;
            list.innerHTML = '<option value="__NEW__">+ Create New Theme</option>';
            Object.keys(data).forEach(k => list.innerHTML += `<option value="${k}">${k} ${k===active?'(Active)':''}</option>`);
            loadThemeContent();
        }
        function loadThemeContent() {
            const name = document.getElementById('themeName').value;
            document.getElementById('themeEditor').value = name === '__NEW__' ? '' : (document.getElementById('themeLang').value === 'english' ? themesData.english : themesData.urdu)[name];
        }
        async function saveTheme() {
            let name = document.getElementById('themeName').value;
            if(name === '__NEW__' && !(name = prompt("Enter Theme Name:"))) return;
            await fetch('/api/themes/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lang: document.getElementById('themeLang').value, name, css: document.getElementById('themeEditor').value}) });
            await loadThemes(); showToast("Theme Saved!");
        }
        async function activateTheme() {
            const name = document.getElementById('themeName').value;
            if(name === '__NEW__') return showToast("Save first");
            await fetch('/api/themes/activate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lang: document.getElementById('themeLang').value, name}) });
            await loadThemes(); showToast("Activated!");
        }
        async function deleteTheme() {
            const name = document.getElementById('themeName').value;
            if(name === '__NEW__' || name === 'Default') return showToast("Cannot delete");
            if(confirm("Delete " + name + "?") && (await (await fetch('/api/themes/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lang: document.getElementById('themeLang').value, name}) })).json()).success) { await loadThemes(); showToast("Deleted"); }
        }

        async function loadExplorer(path) {
            currentPath = path; document.getElementById('currentPathLabel').innerText = path || '/root';
            const files = await (await fetch('/api/files?path=' + path)).json();
            const list = document.getElementById('explorerList'); list.innerHTML = '';
            if (path) {
                 const upDiv = document.createElement('div'); upDiv.className = 'item'; upDiv.innerHTML = '<div><i class="fa-solid fa-turn-up folder-icon"></i> ..</div>';
                 upDiv.onclick = () => loadExplorer(path.split('/').slice(0,-1).join('/')); list.appendChild(upDiv);
            }
            files.forEach(f => {
                const d = document.createElement('div'); d.className = 'item';
                d.innerHTML = '<div>' + (f.isDir ? '<i class="fa-solid fa-folder folder-icon"></i>' : '<i class="fa-solid fa-file-lines file-icon"></i>') + f.name + '</div>';
                d.onclick = (e) => { if(!e.target.classList.contains('fa-trash')) f.isDir ? loadExplorer(f.relativePath) : loadFile(f.relativePath); };
                const delBtn = document.createElement('i'); delBtn.className = 'fa-solid fa-trash action-icon';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteItem(f.relativePath); };
                d.appendChild(delBtn); list.appendChild(d);
            });
        }
        async function createFolder() {
            const name = prompt("Folder Name:");
            if(name) { await fetch('/api/folder/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path: currentPath ? currentPath + '/' + name : name }) }); loadExplorer(currentPath); showToast("Folder Created"); }
        }
        async function deleteItem(path) {
            if(confirm("Delete " + path + "?")) { await fetch('/api/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path }) }); loadExplorer(currentPath); showToast("Deleted"); }
        }
        function importFile(input) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = async (e) => { await fetch('/api/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path: currentPath, filename: input.files[0].name, content: e.target.result }) }); loadExplorer(currentPath); showToast("Imported"); };
            r.readAsText(input.files[0]);
        }

        async function processCurrentFolder() {
            const files = await (await fetch('/api/files?path=' + currentPath)).json();
            const mdFiles = files.filter(f => !f.isDir && f.name.endsWith('.md'));
            if(mdFiles.length === 0) return showToast('No MD files found');
            if(!confirm("Generate " + mdFiles.length + " PDFs?")) return;
            for(let i=0; i<mdFiles.length; i++) {
                setStatus("Batch: " + (i+1) + "/" + mdFiles.length, true);
                const cData = await (await fetch('/api/file-content?path='+mdFiles[i].relativePath)).json();
                await doGenerate(cData.content, mdFiles[i].name, false);
            }
            setStatus("Ready"); showToast("Batch Complete!");
        }

        async function magicFind() {
            const codes = document.getElementById('magicCode').value.split(' ').filter(c=>c);
            if(codes.length === 0) return;
            const data = await (await fetch('/api/magic-find', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ codes }) })).json();
            const resDiv = document.getElementById('magicResults'); resDiv.innerHTML = '';
            if(data.matches && data.matches.length > 0) {
                const btn = document.createElement('button'); btn.className = 'btn'; btn.style.background = '#e91e63'; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Generate Found (' + data.matches.length + ')';
                btn.onclick = async () => {
                     for(let i=0; i<data.matches.length; i++) {
                        setStatus('Magic: '+(i+1)+'/'+data.matches.length, true);
                        const cData = await (await fetch('/api/file-content?path='+data.matches[i].relativePath)).json();
                        await doGenerate(cData.content, data.matches[i].fileName, false);
                    }
                    setStatus('Ready'); showToast("Magic Done!");
                };
                resDiv.appendChild(btn);
            } else showToast("No matches");
        }

        async function loadFile(path) {
            document.getElementById('fileName').value = path.split('/').pop();
            document.getElementById('editor').value = (await (await fetch('/api/file-content?path='+path)).json()).content;
            switchTab('editor');
        }
        async function saveFile() {
            const name = document.getElementById('fileName').value;
            await fetch('/api/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path: currentPath ? currentPath + '/' + name : name, content: document.getElementById('editor').value }) });
            showToast('Saved!'); loadExplorer(currentPath);
        }
        function saveConfig() {
            const cfg = {}; ['cfgName','cfgRoll','cfgSem','cfgNameUr','cfgRollUr','cfgSemUr'].forEach(id => cfg[id] = document.getElementById(id).value);
            localStorage.setItem('aiou_config', JSON.stringify(cfg)); showToast('Settings Saved');
        }
        async function generatePdf() {
            setStatus('Compiling PDF...', true); document.getElementById('genPdfBtn').disabled = true;
            await doGenerate(document.getElementById('editor').value, document.getElementById('fileName').value, true);
            document.getElementById('genPdfBtn').disabled = false; setStatus('Ready');
        }
        async function doGenerate(content, filename, showAlert) {
            const cfg = JSON.parse(localStorage.getItem('aiou_config') || '{}');
            const conf = { name: cfg.cfgName, roll: cfg.cfgRoll, semester: cfg.cfgSem, nameUrdu: cfg.cfgNameUr, rollUrdu: cfg.cfgRollUr, semesterUrdu: cfg.cfgSemUr };
            try {
                const data = await (await fetch('/api/generate-pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content, config: conf, filename }) })).json();
                if(showAlert) data.success ? showToast('PDF Saved Successfully!') : showToast('Error: ' + data.error);
            } catch(e) { if(showAlert) showToast("Connection Error"); }
        }
    </script>
</body>
</html>
